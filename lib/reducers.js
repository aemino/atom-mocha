"use strict";

Object.defineProperty(exports, "__esModule", {
    value: true
});

var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };

function _toConsumableArray(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = Array(arr.length); i < arr.length; i++) arr2[i] = arr[i]; return arr2; } else { return Array.from(arr); } }

var _redux = require('redux');

var _actions = require("./actions");

function identity(defaultValue) {
    return function (x) {
        return x || defaultValue;
    };
}

function updateSuiteToggleState(suites, id, state) {
    var suite = _extends({}, suites[id]);
    var result = _extends({}, suites);
    suite.toggleState = state;
    result[id] = suite;
    return result;
}

function expand(_x2) {
    var _arguments = arguments;
    var _again = true;

    _function: while (_again) {
        var suites = _x2;
        id = suite = undefined;
        _again = false;
        var id = _arguments.length <= 1 || _arguments[1] === undefined ? null : _arguments[1];

        if (!id) {
            return suites;
        }
        var suite = suites[id];
        _arguments = [_x2 = updateSuiteToggleState(suites, id, "expanded"), suite.parent];
        _again = true;
        continue _function;
    }
}

function expandParents(state, testId) {
    var _state$entities = state.entities;
    var tests = _state$entities.tests;
    var suites = _state$entities.suites;

    var test = tests[testId];
    if (test.status === "failed") {
        return _extends({}, state, {
            entities: {
                suites: expand(suites, test.parent),
                tests: tests
            }
        });
    }
    return state;
}

function toggleSuite(suites, id) {
    var state = suites[id].toggleState;
    return updateSuiteToggleState(suites, id, state === "collapsed" ? "expanded" : "collapsed");
}

function suites(suites, action) {
    if (suites === undefined) suites = {};

    if (action.type === _actions.Actions.TOGGLE_SUITE) {
        return toggleSuite(suites, action.suite);
    }
    return suites;
}

function updateTestStatus(tests, id, status, error) {
    var test = _extends({}, tests[id]);
    test.status = status;
    if (error) {
        test.error = error;
    }
    var result = _extends({}, tests);
    result[id] = test;
    return result;
}

function tests(tests, action) {
    if (tests === undefined) tests = {};

    if (action.type === _actions.Actions.BEGIN_TEST) {
        var id = action.test.id;

        return updateTestStatus(tests, id, "pending");
    }
    if (action.type === _actions.Actions.END_TEST) {
        var _action$test = action.test;
        var id = _action$test.id;
        var state = _action$test.state;
        var error = _action$test.error;

        return updateTestStatus(tests, id, state, error);
    }
    return tests;
}

function count(what) {
    return function (total, object) {
        if (object.status === what) {
            return total + 1;
        }
        return total;
    };
}

function determineStatus(suite, tests, suites) {

    var testStatus = {
        failed: tests.reduce(count("failed"), 0),
        passed: tests.reduce(count("passed"), 0)
    };
    if (testStatus.failed > 0 && testStatus.passed === 0) {
        return "failed";
    }
    if (testStatus.failed === 0 && testStatus.passed > 0) {
        return "passed";
    }
    if (testStatus.failed > 0 && testStatus.passed > 0) {
        return "partial";
    }

    var suiteStatus = {
        partial: suites.reduce(count("partial"), 0),
        failed: suites.reduce(count("failed"), 0),
        passed: suites.reduce(count("passed"), 0)
    };
    if (suiteStatus.partial > 0) {
        return "partial";
    }
    if (suiteStatus.failed > 0 && suiteStatus.passed === 0) {
        return "failed";
    }
    if (suiteStatus.failed === 0 && suiteStatus.passed > 0) {
        return "passed";
    }
    return "partial";
}
function updateSuiteStatus(suites, tests, id) {
    var suite = _extends({}, suites[id]);
    var suiteTests = suite.tests.map(function (s) {
        return tests[s];
    });
    var childSuites = suite.suites.map(function (s) {
        return suites[s];
    });
    suite.status = determineStatus(suite, suiteTests, childSuites);
    var result = _extends({}, suites);
    result[id] = suite;
    return result;
}

function setSuiteStatus(state, suite) {
    var id = suite.id;
    var _state$entities2 = state.entities;
    var suites = _state$entities2.suites;
    var tests = _state$entities2.tests;

    return _extends({}, state, {
        entities: {
            suites: updateSuiteStatus(suites, tests, id),
            tests: tests
        }
    });
}

var suitesAndTests = (0, _redux.combineReducers)({ suites: suites, tests: tests });
var entitiesAndResult = (0, _redux.combineReducers)({
    entities: suitesAndTests,
    result: identity([]),
    stats: identity(null)
});

var initialState = {
    stats: null,
    entities: {
        suites: {},
        tests: {}
    },
    result: []
};

exports["default"] = function (state, action) {
    if (state === undefined) state = initialState;

    if (action.type === _actions.Actions.RESTART) {
        return initialState;
    }
    if (action.type === _actions.Actions.BEGIN) {
        var _action$data = action.data;
        var result = _action$data.result;
        var entities = _action$data.entities;

        return {
            entities: {
                suites: _extends({}, entities.suites),
                tests: _extends({}, entities.tests)
            },
            result: [].concat(_toConsumableArray(result))
        };
    }

    if (action.type === _actions.Actions.END) {
        var stats = action.data.stats;

        return _extends({}, state, { stats: stats });
    }
    if (action.type === _actions.Actions.END_TEST) {
        var _action$test2 = action.test;
        var _status = _action$test2.status;
        var id = _action$test2.id;

        return expandParents(entitiesAndResult(state, action), id);
    }
    if (action.type === _actions.Actions.END_SUITE) {
        return setSuiteStatus(entitiesAndResult(state, action), action.suite);
    }
    return entitiesAndResult(state, action);
};

;
module.exports = exports["default"];
//# sourceMappingURL=data:application/json;base64,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QUFLLEVBQUUsTUFBTSxDQUFDLEVBQUUsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO0tBQ3pFO0FBQ0QsV0FBTyxpQkFBaUIsQ0FBQyxLQUFLLEVBQUUsTUFBTSxDQUFDLENBQUM7Q0FDM0M7O0FBQUEsQ0FBQyIsImZpbGUiOiJyZWR1Y2Vycy5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGNvbWJpbmVSZWR1Y2VycyB9IGZyb20gJ3JlZHV4JztcclxuaW1wb3J0IHtBY3Rpb25zfSBmcm9tIFwiLi9hY3Rpb25zXCI7XHJcblxyXG5mdW5jdGlvbiBpZGVudGl0eShkZWZhdWx0VmFsdWUpe1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uKHgpe1xyXG4gICAgICAgIHJldHVybiB4IHx8IGRlZmF1bHRWYWx1ZTtcclxuICAgIH07XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHVwZGF0ZVN1aXRlVG9nZ2xlU3RhdGUoc3VpdGVzLCBpZCwgc3RhdGUpe1xyXG4gICAgY29uc3Qgc3VpdGUgPSB7Li4uc3VpdGVzW2lkXX07XHJcbiAgICBjb25zdCByZXN1bHQgPSB7IC4uLnN1aXRlcyB9O1xyXG4gICAgc3VpdGUudG9nZ2xlU3RhdGUgPSBzdGF0ZTtcclxuICAgIHJlc3VsdFtpZF0gPSBzdWl0ZTtcclxuICAgIHJldHVybiByZXN1bHQ7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGV4cGFuZChzdWl0ZXMsIGlkID0gbnVsbCl7XHJcbiAgICBpZighaWQpe1xyXG4gICAgICAgIHJldHVybiBzdWl0ZXM7XHJcbiAgICB9XHJcbiAgICBjb25zdCBzdWl0ZSA9IHN1aXRlc1tpZF07XHJcbiAgICByZXR1cm4gZXhwYW5kKHVwZGF0ZVN1aXRlVG9nZ2xlU3RhdGUoc3VpdGVzLCBpZCwgXCJleHBhbmRlZFwiKSwgc3VpdGUucGFyZW50KTtcclxufVxyXG5cclxuZnVuY3Rpb24gZXhwYW5kUGFyZW50cyhzdGF0ZSwgdGVzdElkKXtcclxuICAgIGNvbnN0IHt0ZXN0cywgc3VpdGVzfSA9IHN0YXRlLmVudGl0aWVzO1xyXG4gICAgY29uc3QgdGVzdCA9IHRlc3RzW3Rlc3RJZF07XHJcbiAgICBpZih0ZXN0LnN0YXR1cyA9PT0gXCJmYWlsZWRcIil7XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgLi4uc3RhdGUsXHJcbiAgICAgICAgICAgIGVudGl0aWVzIDoge1xyXG4gICAgICAgICAgICAgICAgc3VpdGVzIDogZXhwYW5kKHN1aXRlcywgdGVzdC5wYXJlbnQpLFxyXG4gICAgICAgICAgICAgICAgdGVzdHMgOiB0ZXN0c1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuICAgIHJldHVybiBzdGF0ZTtcclxufVxyXG5cclxuZnVuY3Rpb24gdG9nZ2xlU3VpdGUoc3VpdGVzLCBpZCl7XHJcbiAgICBjb25zdCBzdGF0ZSA9IHN1aXRlc1tpZF0udG9nZ2xlU3RhdGU7XHJcbiAgICByZXR1cm4gdXBkYXRlU3VpdGVUb2dnbGVTdGF0ZShzdWl0ZXMsIGlkLCBzdGF0ZSA9PT0gXCJjb2xsYXBzZWRcIiA/IFwiZXhwYW5kZWRcIiA6IFwiY29sbGFwc2VkXCIpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBzdWl0ZXMoc3VpdGVzID0ge30sIGFjdGlvbil7XHJcbiAgICBpZihhY3Rpb24udHlwZSA9PT0gQWN0aW9ucy5UT0dHTEVfU1VJVEUpe1xyXG4gICAgICAgIHJldHVybiB0b2dnbGVTdWl0ZShzdWl0ZXMsIGFjdGlvbi5zdWl0ZSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gc3VpdGVzO1xyXG59XHJcblxyXG5mdW5jdGlvbiB1cGRhdGVUZXN0U3RhdHVzKHRlc3RzLCBpZCwgc3RhdHVzLCBlcnJvcil7XHJcbiAgICBjb25zdCB0ZXN0ID0gey4uLnRlc3RzW2lkXX07XHJcbiAgICB0ZXN0LnN0YXR1cyA9IHN0YXR1cztcclxuICAgIGlmKGVycm9yKXtcclxuICAgICAgICB0ZXN0LmVycm9yID0gZXJyb3I7XHJcbiAgICB9XHJcbiAgICBjb25zdCByZXN1bHQgPSB7IC4uLnRlc3RzIH1cclxuICAgIHJlc3VsdFtpZF0gPSB0ZXN0O1xyXG4gICAgcmV0dXJuIHJlc3VsdDtcclxufVxyXG5cclxuZnVuY3Rpb24gdGVzdHModGVzdHMgPSB7fSwgYWN0aW9uKXtcclxuICAgIGlmKGFjdGlvbi50eXBlID09PSBBY3Rpb25zLkJFR0lOX1RFU1Qpe1xyXG4gICAgICAgIGNvbnN0IHtpZH0gPSBhY3Rpb24udGVzdDtcclxuICAgICAgICByZXR1cm4gdXBkYXRlVGVzdFN0YXR1cyh0ZXN0cywgaWQsIFwicGVuZGluZ1wiKTtcclxuICAgIH1cclxuICAgIGlmKGFjdGlvbi50eXBlID09PSBBY3Rpb25zLkVORF9URVNUKXtcclxuICAgICAgICBjb25zdCB7aWQsIHN0YXRlLCBlcnJvcn0gPSBhY3Rpb24udGVzdDtcclxuICAgICAgICByZXR1cm4gdXBkYXRlVGVzdFN0YXR1cyh0ZXN0cywgaWQsIHN0YXRlLCBlcnJvcik7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdGVzdHM7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGNvdW50KHdoYXQpe1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uKHRvdGFsLCBvYmplY3Qpe1xyXG4gICAgICAgIGlmKG9iamVjdC5zdGF0dXMgPT09IHdoYXQpe1xyXG4gICAgICAgICAgICByZXR1cm4gdG90YWwgKyAxO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdG90YWw7XHJcbiAgICB9O1xyXG59XHJcblxyXG5mdW5jdGlvbiBkZXRlcm1pbmVTdGF0dXMoc3VpdGUsIHRlc3RzLCBzdWl0ZXMpe1xyXG5cclxuICAgIGNvbnN0IHRlc3RTdGF0dXMgPSB7XHJcbiAgICAgICAgZmFpbGVkIDogdGVzdHMucmVkdWNlKGNvdW50KFwiZmFpbGVkXCIpLCAwKSxcclxuICAgICAgICBwYXNzZWQgOiB0ZXN0cy5yZWR1Y2UoY291bnQoXCJwYXNzZWRcIiksIDApXHJcbiAgICB9O1xyXG4gICAgaWYodGVzdFN0YXR1cy5mYWlsZWQgPiAwICYmIHRlc3RTdGF0dXMucGFzc2VkID09PSAwKXtcclxuICAgICAgICByZXR1cm4gXCJmYWlsZWRcIjtcclxuICAgIH1cclxuICAgIGlmKHRlc3RTdGF0dXMuZmFpbGVkID09PSAwICYmIHRlc3RTdGF0dXMucGFzc2VkID4gMCl7XHJcbiAgICAgICAgcmV0dXJuIFwicGFzc2VkXCI7XHJcbiAgICB9XHJcbiAgICBpZih0ZXN0U3RhdHVzLmZhaWxlZCA+IDAgJiYgdGVzdFN0YXR1cy5wYXNzZWQgPiAwKXtcclxuICAgICAgICByZXR1cm4gXCJwYXJ0aWFsXCI7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIGNvbnN0IHN1aXRlU3RhdHVzID0ge1xyXG4gICAgICAgIHBhcnRpYWwgOiBzdWl0ZXMucmVkdWNlKGNvdW50KFwicGFydGlhbFwiKSwgMCksXHJcbiAgICAgICAgZmFpbGVkIDogc3VpdGVzLnJlZHVjZShjb3VudChcImZhaWxlZFwiKSwgMCksXHJcbiAgICAgICAgcGFzc2VkIDogc3VpdGVzLnJlZHVjZShjb3VudChcInBhc3NlZFwiKSwgMClcclxuICAgIH07XHJcbiAgICBpZihzdWl0ZVN0YXR1cy5wYXJ0aWFsID4gMCl7XHJcbiAgICAgICAgcmV0dXJuIFwicGFydGlhbFwiO1xyXG4gICAgfVxyXG4gICAgaWYoc3VpdGVTdGF0dXMuZmFpbGVkID4gMCAmJiBzdWl0ZVN0YXR1cy5wYXNzZWQgPT09IDApe1xyXG4gICAgICAgIHJldHVybiBcImZhaWxlZFwiO1xyXG4gICAgfVxyXG4gICAgaWYoc3VpdGVTdGF0dXMuZmFpbGVkID09PSAwICYmIHN1aXRlU3RhdHVzLnBhc3NlZCA+IDApe1xyXG4gICAgICAgIHJldHVybiBcInBhc3NlZFwiO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIFwicGFydGlhbFwiO1xyXG59XHJcbmZ1bmN0aW9uIHVwZGF0ZVN1aXRlU3RhdHVzKHN1aXRlcywgdGVzdHMsIGlkKXtcclxuICAgIGNvbnN0IHN1aXRlID0gey4uLnN1aXRlc1tpZF19O1xyXG4gICAgY29uc3Qgc3VpdGVUZXN0cyA9IHN1aXRlLnRlc3RzLm1hcChzID0+IHtcclxuICAgICAgICByZXR1cm4gdGVzdHNbc107XHJcbiAgICB9KTtcclxuICAgIGNvbnN0IGNoaWxkU3VpdGVzID0gc3VpdGUuc3VpdGVzLm1hcCggcyA9PiB7XHJcbiAgICAgICAgcmV0dXJuIHN1aXRlc1tzXTtcclxuICAgIH0pO1xyXG4gICAgc3VpdGUuc3RhdHVzID0gZGV0ZXJtaW5lU3RhdHVzKHN1aXRlLCBzdWl0ZVRlc3RzLCBjaGlsZFN1aXRlcyk7XHJcbiAgICBjb25zdCByZXN1bHQgPSB7IC4uLnN1aXRlcyB9XHJcbiAgICByZXN1bHRbaWRdID0gc3VpdGU7XHJcbiAgICByZXR1cm4gcmVzdWx0O1xyXG59XHJcblxyXG5mdW5jdGlvbiBzZXRTdWl0ZVN0YXR1cyhzdGF0ZSwgc3VpdGUpe1xyXG4gICAgY29uc3Qge2lkfSA9IHN1aXRlO1xyXG4gICAgY29uc3Qge3N1aXRlcywgdGVzdHN9ID0gc3RhdGUuZW50aXRpZXM7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICAgIC4uLnN0YXRlLFxyXG4gICAgICAgIGVudGl0aWVzIDoge1xyXG4gICAgICAgICAgICBzdWl0ZXMgOiB1cGRhdGVTdWl0ZVN0YXR1cyhzdWl0ZXMsIHRlc3RzLCBpZCksXHJcbiAgICAgICAgICAgIHRlc3RzIDogdGVzdHNcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuXHJcbmNvbnN0IHN1aXRlc0FuZFRlc3RzID0gY29tYmluZVJlZHVjZXJzKCB7IHN1aXRlcywgdGVzdHN9ICk7XHJcbmNvbnN0IGVudGl0aWVzQW5kUmVzdWx0ID0gY29tYmluZVJlZHVjZXJzKHtcclxuICAgIGVudGl0aWVzIDogc3VpdGVzQW5kVGVzdHMsXHJcbiAgICByZXN1bHQgOiBpZGVudGl0eShbXSksXHJcbiAgICBzdGF0cyA6IGlkZW50aXR5KG51bGwpXHJcbn0pO1xyXG5cclxuY29uc3QgaW5pdGlhbFN0YXRlID0ge1xyXG4gICAgc3RhdHMgOiBudWxsLFxyXG4gICAgZW50aXRpZXMgOiB7XHJcbiAgICAgICAgc3VpdGVzIDoge30sXHJcbiAgICAgICAgdGVzdHMgOiB7fVxyXG4gICAgfSxcclxuICAgIHJlc3VsdCA6IFtdXHJcbn07XHJcbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uKHN0YXRlID0gaW5pdGlhbFN0YXRlLCBhY3Rpb24pe1xyXG4gICAgaWYoYWN0aW9uLnR5cGUgPT09IEFjdGlvbnMuUkVTVEFSVCl7XHJcbiAgICAgICAgcmV0dXJuIGluaXRpYWxTdGF0ZTtcclxuICAgIH1cclxuICAgIGlmKGFjdGlvbi50eXBlID09PSBBY3Rpb25zLkJFR0lOKXtcclxuICAgICAgICBjb25zdCB7cmVzdWx0LCBlbnRpdGllc30gPSBhY3Rpb24uZGF0YTtcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICBlbnRpdGllcyA6IHtcclxuICAgICAgICAgICAgICAgIHN1aXRlcyA6IHsgLi4uZW50aXRpZXMuc3VpdGVzfSxcclxuICAgICAgICAgICAgICAgIHRlc3RzIDogey4uLmVudGl0aWVzLnRlc3RzfVxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICByZXN1bHQgOiBbLi4ucmVzdWx0XVxyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgaWYoYWN0aW9uLnR5cGUgPT09IEFjdGlvbnMuRU5EKXtcclxuICAgICAgICBjb25zdCB7c3RhdHN9ID0gYWN0aW9uLmRhdGE7XHJcbiAgICAgICAgcmV0dXJuIHsgLi4uc3RhdGUsIHN0YXRzIH07XHJcbiAgICB9XHJcbiAgICBpZihhY3Rpb24udHlwZSA9PT0gQWN0aW9ucy5FTkRfVEVTVCl7XHJcbiAgICAgICAgY29uc3Qge3N0YXR1cywgaWR9ID0gYWN0aW9uLnRlc3Q7XHJcbiAgICAgICAgcmV0dXJuIGV4cGFuZFBhcmVudHMoZW50aXRpZXNBbmRSZXN1bHQoc3RhdGUsIGFjdGlvbiksIGlkKTtcclxuICAgIH1cclxuICAgIGlmKGFjdGlvbi50eXBlID09PSBBY3Rpb25zLkVORF9TVUlURSl7XHJcbiAgICAgICAgcmV0dXJuIHNldFN1aXRlU3RhdHVzKGVudGl0aWVzQW5kUmVzdWx0KHN0YXRlLCBhY3Rpb24pLCBhY3Rpb24uc3VpdGUpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGVudGl0aWVzQW5kUmVzdWx0KHN0YXRlLCBhY3Rpb24pO1xyXG59O1xyXG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
